<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Oracle Employee Management</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    input, select { padding: 8px; margin: 5px 0; width: 260px; }
    button { padding: 8px 16px; margin-top: 10px; }
    table { border-collapse: collapse; margin-top: 20px; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background: #f0f0f0; }
    tr:hover { background: #eaf2ff; cursor: pointer; }
    .box { border: 1px solid #ccc; padding: 15px; margin-top: 20px; width: 480px; }
    .error { color: red; margin-top: 10px; }
    .success { color: green; margin-top: 10px; }
  </style>
</head>
<body>

<h2>üîê Oracle Login</h2>
<div class="box">
  <input type="text" id="login_username" placeholder="Oracle username" /><br />
  <input type="password" id="login_password" placeholder="Oracle password" /><br />
  <button onclick="login()">Login & Load Employees</button>
  <div id="loginError" class="error"></div>
</div>

<!-- ================= INSERT ================= -->
<h2>‚ûï Create Employee</h2>
<div class="box">
  <input type="number" id="c_emp_id" placeholder="Employee ID (3 digits)" /><br />
  <input type="text" id="c_full_name" placeholder="Full name" /><br />
  <input type="date" id="c_dob" /><br />
  <input type="email" id="c_email" placeholder="Email" /><br />

  <select id="c_dept">
    <option value="IT">IT</option>
    <option value="HR">HR</option>
    <option value="ACCT">ACCT</option>
  </select><br />

  <input type="number" id="c_salary" placeholder="Salary" /><br />
  <input type="text" id="c_tax_code" placeholder="Tax code" /><br />
  <input type="password" id="c_oracle_password" placeholder="Oracle password (new user)" /><br />

  <button onclick="createEmployee()">Create Employee</button>
  <div id="createMsg"></div>
</div>

<!-- ================= UPDATE ================= -->
<h2>‚úèÔ∏è Update Employee</h2>
<div class="box">
  <input type="number" id="u_emp_id" disabled /><br />
  <input type="text" id="u_full_name" /><br />
  <input type="date" id="u_dob" /><br />
  <input type="email" id="u_email" /><br />

  <select id="u_dept">
    <option value="IT">IT</option>
    <option value="HR">HR</option>
    <option value="ACCT">ACCT</option>
  </select><br />

  <input type="number" id="u_salary" /><br />
  <input type="text" id="u_tax_code" /><br />

  <button onclick="updateEmployee()">Update Employee</button>
  <div id="updateMsg"></div>
</div>

<!-- ================= TABLE ================= -->
<table id="resultTable" style="display:none">
  <thead>
    <tr>
      <th>EMP_ID</th>
      <th>FULL_NAME</th>
      <th>DOB</th>
      <th>EMAIL</th>
      <th>DEPT_ID</th>
      <th>SALARY</th>
      <th>TAX_CODE</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const API_BASE = 'http://localhost:3000/api/employees';
let currentUser = null;

/* ================= LOGIN ================= */
async function login() {
  try {
    const res = await fetch(API_BASE, {
      headers: {
        username: login_username.value,
        password: login_password.value
      }
    });
    if (!res.ok) throw new Error();
    currentUser = {
      username: login_username.value,
      password: login_password.value
    };
    renderTable(await res.json());
  } catch {
    loginError.innerText = '‚ùå ƒêƒÉng nh·∫≠p Oracle th·∫•t b·∫°i';
  }
}

/* ================= INSERT ================= */
async function createEmployee() {
  if (!currentUser) return alert('Login tr∆∞·ªõc');

  const body = {
    emp_id: c_emp_id.value,
    full_name: c_full_name.value,
    dob: c_dob.value,
    email: c_email.value,
    dept: c_dept.value,
    salary: c_salary.value,
    tax_code: c_tax_code.value,
    oracle_password: c_oracle_password.value
  };

  try {
    const res = await fetch(`${API_BASE}/create`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        username: currentUser.username,
        password: currentUser.password
      },
      body: JSON.stringify(body)
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.error);

    createMsg.innerHTML = `<div class="success">‚úÖ Created ${data.oracle_user}</div>`;
    login();
  } catch (e) {
    createMsg.innerHTML = `<div class="error">‚ùå ${e.message}</div>`;
  }
}

/* ================= TABLE ================= */
function renderTable(rows) {
  const tbody = document.querySelector('#resultTable tbody');
  tbody.innerHTML = '';
  rows.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.EMP_ID}</td>
      <td>${r.FULL_NAME}</td>
      <td>${r.DOB?.substring(0,10) || ''}</td>
      <td>${r.EMAIL}</td>
      <td>${r.DEPT_ID}</td>
      <td>${r.SALARY}</td>
      <td>${r.TAX_CODE}</td>`;
    tr.onclick = () => fillForm(r);
    tbody.appendChild(tr);
  });
  resultTable.style.display = 'table';
}

/* ================= FILL ================= */
function fillForm(r) {
  u_emp_id.value = r.EMP_ID;
  u_full_name.value = r.FULL_NAME;
  u_dob.value = r.DOB?.substring(0,10) || '';
  u_email.value = r.EMAIL;
  u_dept.value = r.DEPT_ID;
  u_salary.value = r.SALARY;
  u_tax_code.value = r.TAX_CODE;
}

/* ================= UPDATE ================= */
async function updateEmployee() {
  if (!currentUser) return alert('Login tr∆∞·ªõc');
  if (!u_emp_id.value) return alert('Ch∆∞a ch·ªçn nh√¢n vi√™n');

  const body = {
    full_name: u_full_name.value,
    dob: u_dob.value,
    email: u_email.value,
    dept_id: u_dept.value,
    salary: u_salary.value,
    tax_code: u_tax_code.value
  };

  const res = await fetch(`${API_BASE}/${u_emp_id.value}`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
      username: currentUser.username,
      password: currentUser.password
    },
    body: JSON.stringify(body)
  });

  updateMsg.innerHTML = res.ok
    ? `<div class="success">‚úÖ Update th√†nh c√¥ng</div>`
    : `<div class="error">‚ùå Update th·∫•t b·∫°i</div>`;

  login();
}
</script>

</body>
</html>

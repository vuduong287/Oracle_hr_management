<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Oracle Employee Management</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    input, select { padding: 8px; margin: 5px 0; width: 260px; }
    button { padding: 8px 16px; margin-top: 10px; }
    table { border-collapse: collapse; margin-top: 20px; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background: #f0f0f0; }
    tr:hover { background: #eaf2ff; cursor: pointer; }
    .box { border: 1px solid #ccc; padding: 15px; margin-top: 20px; width: 480px; }
    .error { color: red; margin-top: 10px; }
    .success { color: green; margin-top: 10px; }
  </style>
</head>
<body>

<h2>üîê Oracle Login</h2>

<div class="box">
  <input type="text" id="login_username" placeholder="Oracle username" /><br />
  <input type="password" id="login_password" placeholder="Oracle password" /><br />
  <button onclick="login()">Login & Load Employees</button>
  <div id="loginError" class="error"></div>
</div>

<!-- ================= UPDATE FORM ================= -->
<h2>‚úèÔ∏è Update Employee</h2>

<div class="box">
  <input type="number" id="u_emp_id" placeholder="Employee ID" disabled /><br />
  <input type="text" id="u_full_name" placeholder="Full name" /><br />
  <input type="date" id="u_dob" /><br />
  <input type="email" id="u_email" placeholder="Email" /><br />

  <label>Department</label><br />
  <select id="u_dept">
    <option value="IT">IT</option>
    <option value="HR">HR</option>
    <option value="ACCT">ACCT</option>
  </select><br />

  <input type="number" id="u_salary" placeholder="Salary" /><br />
  <input type="text" id="u_tax_code" placeholder="Tax code" /><br />

  <button onclick="updateEmployee()">Update Employee</button>
  <div id="updateMsg"></div>
</div>

<!-- ================= TABLE ================= -->
<table id="resultTable" style="display:none">
  <thead>
    <tr>
      <th>EMP_ID</th>
      <th>FULL_NAME</th>
      <th>DOB</th>
      <th>EMAIL</th>
      <th>DEPT_ID</th>
      <th>SALARY</th>
      <th>TAX_CODE</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const API_BASE = 'http://localhost:3000/api/employees';
let currentUser = null;

/* ================= LOGIN ================= */
async function login() {
  const username = login_username.value;
  const password = login_password.value;

  loginError.innerText = '';
  resultTable.style.display = 'none';

  try {
    const res = await fetch(API_BASE, {
      headers: { username, password }
    });
    if (!res.ok) throw new Error();

    currentUser = { username, password };
    const data = await res.json();
    renderTable(data);
  } catch {
    loginError.innerText = '‚ùå ƒêƒÉng nh·∫≠p Oracle th·∫•t b·∫°i';
  }
}

/* ================= RENDER TABLE ================= */
function renderTable(rows) {
  const tbody = document.querySelector('#resultTable tbody');
  tbody.innerHTML = '';

  rows.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.EMP_ID}</td>
      <td>${r.FULL_NAME}</td>
      <td>${r.DOB ? r.DOB.substring(0,10) : ''}</td>
      <td>${r.EMAIL}</td>
      <td>${r.DEPT_ID}</td>
      <td>${r.SALARY}</td>
      <td>${r.TAX_CODE}</td>
    `;
    tr.onclick = () => fillForm(r);
    tbody.appendChild(tr);
  });

  resultTable.style.display = 'table';
}

/* ================= FILL FORM ================= */
function fillForm(r) {
  u_emp_id.value = r.EMP_ID;
  u_full_name.value = r.FULL_NAME;
  u_dob.value = r.DOB ? r.DOB.substring(0,10) : '';
  u_email.value = r.EMAIL;
  u_dept.value = r.DEPT_ID;
  u_salary.value = r.SALARY;
  u_tax_code.value = r.TAX_CODE;
}

/* ================= UPDATE EMPLOYEE ================= */
async function updateEmployee() {
  if (!currentUser) return alert('B·∫°n c·∫ßn login tr∆∞·ªõc');

  const empId = u_emp_id.value;
  if (!empId) return alert('Ch∆∞a ch·ªçn nh√¢n vi√™n');

  const body = {
    full_name: u_full_name.value,
    dob: u_dob.value,
    email: u_email.value,
    dept_id: u_dept.value,
    salary: u_salary.value,
    tax_code: u_tax_code.value
  };

  try {
    const res = await fetch(`${API_BASE}/${empId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        username: currentUser.username,
        password: currentUser.password
      },
      body: JSON.stringify(body)
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.message);

    updateMsg.innerHTML = `<div class="success">‚úÖ Update th√†nh c√¥ng</div>`;
    login(); // reload table

  } catch (err) {
    updateMsg.innerHTML =
      `<div class="error">‚ùå ${err.message}</div>`;
  }
}
</script>

</body>
</html>
